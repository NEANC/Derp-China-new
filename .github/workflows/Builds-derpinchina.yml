name: è‡ªåŠ¨æž„å»º:Derpin-China

on:
  schedule:
    # æ¯å‘¨ä¸€ 00:00 åŒ—äº¬æ—¶é—´ æ‰§è¡Œ
    - cron: '0 0 * * 1'
      timezone: Asia/Shanghai
  # å½“PRåˆå¹¶åˆ°ä¸»çº¿æ—¶è‡ªåŠ¨æ‰§è¡Œæž„å»º
  pull_request:
    types: [ closed ]
    branches: [ main ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™é…ç½®ï¼šä»…æŽˆäºˆGHCRæŽ¨é€å¿…éœ€çš„æœ€å°æƒé™
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-24.04

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # å®‰è£…ä¾èµ–
          sudo apt update && sudo apt install -y curl jq
          # éªŒè¯dockeræ˜¯å¦å·²å®‰è£…ï¼ˆubuntu-24.04 runneré»˜è®¤å¸¦dockerï¼‰
          docker --version
      
      
      - name: Define Image Name
        run: |
          # å®šä¹‰é•œåƒåç§°
          # æŠŠgithub.repository_ownerè½¬ä¸ºçº¯å°å†™ï¼Œé¿å…å¤§å†™å¯¼è‡´çš„é•œåƒåç§°é”™è¯¯
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=${REPO_OWNER_LOWER}/derpin-china" >> $GITHUB_ENV
          echo "Lowercase image name: ghcr.io/${REPO_OWNER_LOWER}/derpin-china"

      - name: Generate Tag with Version and Date
        run: |
          # ç”ŸæˆåŒ…å«ç‰ˆæœ¬å’Œæ—¥æœŸçš„æ ‡ç­¾(æ ¼å¼ï¼šv{version}_{date})
          # ä½¿ç”¨åŒ—äº¬æ—¶é—´
          BASE_DATE=$(TZ='Asia/Shanghai' date +%Y%m%d)
          
          # èŽ·å–Derperç‰ˆæœ¬å·ï¼ˆç¡®ä¿æœ‰ç‰ˆæœ¬å‰ç¼€vï¼‰
          DERP_VERSION=${{ env.DERP_LATEST_VERSION }}
          if [[ ! $DERP_VERSION =~ ^v ]]; then
            DERP_VERSION="v$DERP_VERSION"
          fi
          
          # ç»„åˆæœ€ç»ˆæ ‡ç­¾
          FINAL_TAG="${DERP_VERSION}_${BASE_DATE}"
          echo "Generated tag: $FINAL_TAG"
          echo "TAG_DATE=$FINAL_TAG" >> $GITHUB_ENV

      # ç™»å½•GHCRï¼ˆä»…æŽ¨é€åˆ°GHCRï¼Œæ— éœ€DockerHubï¼‰
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºé•œåƒï¼ˆä¸´æ—¶æ ‡ç­¾derpinchina:latestï¼‰
      - name: Build Docker Image
        if: steps.check_version_change.outputs.version_changed == 'true'
        run: |
          docker build . \
            -t derpinchina:latest

      
      - name: Check Latest Derper Version
        id: check_derper_version
        run: |
          # èŽ·å–æœ€æ–°çš„Derperç‰ˆæœ¬ä¿¡æ¯
          echo "=== Checking latest Derper version ==="
          
          # åˆ›å»ºä¸´æ—¶Goæ¨¡å—æ¥èŽ·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          mkdir -p /tmp/derper_version && cd /tmp/derper_version
          go mod init derper_version
          
          # èŽ·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          GO111MODULE=on go list -m -versions tailscale.com/cmd/derper > versions.txt 2>/dev/null
          
          # æå–æœ€æ–°ç‰ˆæœ¬å·
          if [ -s versions.txt ]; then
            LATEST_VERSION=$(tail -n 1 versions.txt | awk '{print $NF}')
          else
            # å¦‚æžœæ— æ³•èŽ·å–ç‰ˆæœ¬åˆ—è¡¨ï¼Œå°è¯•é€šè¿‡go getèŽ·å–
            GO111MODULE=on go get tailscale.com/cmd/derper@latest
            LATEST_VERSION=$(go list -m tailscale.com/cmd/derper | awk '{print $2}')
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd / && rm -rf /tmp/derper_version
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
          echo "Latest Derper version: $LATEST_VERSION"
          echo "DERP_LATEST_VERSION=$LATEST_VERSION" >> $GITHUB_ENV
          echo "derp_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          
          # éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if [[ -z $LATEST_VERSION ]]; then
            echo "ERROR: Failed to retrieve latest Derper version!"
            exit 1
          else
            echo "SUCCESS: Retrieved latest Derper version: $LATEST_VERSION"
          fi
      
      - name: Check if Version Changed
        id: check_version_change
        run: |
          # æ£€æŸ¥Derperç‰ˆæœ¬æ˜¯å¦å‘ç”Ÿå˜åŒ–
          echo "=== Checking if Derper version changed ==="
          
          # èŽ·å–å½“å‰å·²å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
          LATEST_RELEASED=$(curl -s https://api.github.com/repos/${{ github.repository }}/packages/container/${{ env.IMAGE_NAME }}/versions | \
                           jq -r '.[] | .metadata.container.tags[]' 2>/dev/null | \
                           grep -E '^v[0-9]+\.[0-9]+\.[0-9]+_[0-9]{8}$' | \
                           sort -V -r | \
                           head -1)
          
          echo "Latest released tag: $LATEST_RELEASED"
          echo "Current version to build: ${{ env.DERP_LATEST_VERSION }}"
          
          # å¦‚æžœæ²¡æœ‰å·²å‘å¸ƒçš„ç‰ˆæœ¬ï¼Œæˆ–è€…ç‰ˆæœ¬å·ä¸åŒï¼Œåˆ™éœ€è¦æž„å»º
          if [[ -z $LATEST_RELEASED ]]; then
            echo "No existing releases found, will build new version"
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            # æå–å·²å‘å¸ƒç‰ˆæœ¬ä¸­çš„ç‰ˆæœ¬å·
            RELEASED_VERSION=$(echo $LATEST_RELEASED | sed 's/_[0-9]*$//')
            CURRENT_VERSION=${{ env.DERP_LATEST_VERSION }}
            if [[ ! $CURRENT_VERSION =~ ^v ]]; then
              CURRENT_VERSION="v$CURRENT_VERSION"
            fi
            
            echo "Released version: $RELEASED_VERSION"
            echo "Current version: $CURRENT_VERSION"
            
            if [[ "$RELEASED_VERSION" != "$CURRENT_VERSION" ]]; then
              echo "Version changed, will build new version"
              echo "version_changed=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged, skipping build"
              echo "version_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Build Docker Image
        run: |
          docker build . \
            -t derpinchina:latest

      - name: Verify Tailscale and Derper Versions in Image
        if: steps.check_version_change.outputs.version_changed == 'true'
        id: verify_versions
        run: |
          # éªŒè¯Tailscaleå’ŒDerperç‰ˆæœ¬
          echo "=== Starting version verification ==="
          # 1. å¯åŠ¨ä¸´æ—¶å®¹å™¨
          CONTAINER_ID=$(docker run -d --rm --entrypoint sh derpinchina:latest -c "sleep 30")
          
          # 2. æå–é•œåƒå†…å®‰è£…çš„Tailscaleç‰ˆæœ¬
          TS_VERSION=$(docker exec $CONTAINER_ID tailscale --version 2>/dev/null | grep -Eo 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          # 3. æå–é•œåƒå†…å®‰è£…çš„Derperç‰ˆæœ¬
          DERP_VERSION=$(docker exec $CONTAINER_ID derper --version 2>/dev/null | grep -Eo 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          # 4. åœæ­¢ä¸´æ—¶å®¹å™¨
          docker stop $CONTAINER_ID >/dev/null 2>&1
          
          # 5. ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°çŽ¯å¢ƒå˜é‡
          echo "TS_VERSION=$TS_VERSION" >> $GITHUB_ENV
          echo "DERP_VERSION=$DERP_VERSION" >> $GITHUB_ENV
          
          # 6. æ‰“å°ç‰ˆæœ¬ä¿¡æ¯
          echo "Installed Tailscale version: $TS_VERSION"
          echo "Installed Derper version: $DERP_VERSION"
          echo "Expected latest version: ${{ env.DERP_LATEST_VERSION }}"
          
          # 7. éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if [[ -z $TS_VERSION || -z $DERP_VERSION ]]; then
            echo "ERROR: Failed to retrieve version information!"
            exit 1
          else
            echo "SUCCESS: Version verification completed!"
          fi

      - name: Tag Image
        if: steps.check_version_change.outputs.version_changed == 'true'
        run: |
          # è®¾ç½®é•œåƒæ ‡ç­¾
          # ç‰ˆæœ¬å·_æ—¥æœŸ
          docker tag derpinchina:latest ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}
          # latest
          docker tag derpinchina:latest ghcr.io/${{ env.IMAGE_NAME }}:latest
          # è¾“å‡ºé•œåƒä¿¡æ¯
          docker images | grep ${{ env.IMAGE_NAME }}

      - name: Push Image
        if: steps.check_version_change.outputs.version_changed == 'true'
        run: |
          # æŽ¨é€é•œåƒ
          docker push ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}
          docker push ghcr.io/${{ env.IMAGE_NAME }}:latest

      # ç™»å‡ºGHCR
      - name: Logout from GHCR
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œç™»å‡º
        run: docker logout ghcr.io

      - name: Build Summary
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¾“å‡ºæ‘˜è¦
        run: |
          # æž„å»ºç»“æžœæ‘˜è¦
          echo "========================================"
          echo "ðŸ“¦ Docker Image Build Summary"
          echo "========================================"
          echo "âœ… Build completed with status: ${{ job.status }}"
          echo ""
          echo "ðŸ“‹ Component Versions:"
          echo "- Tailscale: ${{ env.TS_VERSION || 'Not available' }}"
          echo "- Derper: ${{ env.DERP_VERSION || 'Not available' }}"
          echo ""
          echo "ðŸ³ Container Information:"
          echo "- Registry: ghcr.io"
          echo "- Image Name: ${{ env.IMAGE_NAME }}"
          echo "- Tags: ${{ env.TAG_DATE }}, latest"
          echo "- Full Image Path: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}"
          echo ""
          echo "ðŸ“¤ Push Status:"
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Images pushed successfully to GHCR"
            echo "- Tagged image: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}"
            echo "- Latest image: ghcr.io/${{ env.IMAGE_NAME }}:latest"
          else
            echo "âŒ Image push failed or was skipped"
          fi
          echo ""
          echo "ðŸ“… Build Details:"
          echo "- Build ID: ${{ github.run_id }}"
          echo "- Build URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Trigger: ${{ github.event_name }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "======================================="
          
          # æ·»åŠ GitHub Actions UIä½œä¸šæ‘˜è¦
          echo "## Dockeré•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç»„ä»¶ç‰ˆæœ¬ä¿¡æ¯
          echo "### ðŸ“‹ ç»„ä»¶ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "- **Tailscale**: ${{ env.TS_VERSION || 'ä¸å¯ç”¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Derper**: ${{ env.DERP_VERSION || 'ä¸å¯ç”¨' }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å®¹å™¨ä¿¡æ¯
          echo "### ðŸ³ å®¹å™¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ env.TAG_DATE }}, latest" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Œæ•´é•œåƒè·¯å¾„**: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŽ¨é€çŠ¶æ€
          echo "### ðŸ“¤ æŽ¨é€çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… é•œåƒå·²æˆåŠŸæŽ¨é€åˆ°GHCR" >> $GITHUB_STEP_SUMMARY
            echo "- ç‰ˆæœ¬æ ‡ç­¾: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}" >> $GITHUB_STEP_SUMMARY
            echo "- æœ€æ–°æ ‡ç­¾: ghcr.io/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ é•œåƒæŽ¨é€å¤±è´¥æˆ–è¢«è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºè¯¦æƒ…
          echo "### ðŸ“… æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
