name: è‡ªåŠ¨æž„å»º:derpin-china-new

on:
  schedule:
    # æ¯å‘¨ä¸€ 00:00 UTC æ‰§è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

# æƒé™é…ç½®ï¼šä»…æŽˆäºˆGHCRæŽ¨é€å¿…éœ€çš„æœ€å°æƒé™
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    env:
      # ç›®æ ‡ä»“åº“åœ°å€
      TARGET_REPO: https://github.com/lansepeach/Derp-China-new.git

    steps:
      # å®‰è£…å¿…è¦ä¾èµ–ï¼ˆgitç”¨äºŽå…‹éš†ä»“åº“ï¼‰
      - name: Install dependencies
        run: |
          sudo apt update && sudo apt install -y git
          # éªŒè¯dockeræ˜¯å¦å·²å®‰è£…
          docker --version
      
      # å®šä¹‰é•œåƒåç§°ï¼ˆç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
      - name: Define image name
        run: |
          # æŠŠgithub.repository_ownerè½¬ä¸ºçº¯å°å†™ï¼Œé¿å…å¤§å†™å¯¼è‡´çš„é•œåƒåç§°é”™è¯¯
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=${REPO_OWNER_LOWER}/lansepeach/derpin-china-new" >> $GITHUB_ENV
          echo "Lowercase image name: ghcr.io/${REPO_OWNER_LOWER}/lansepeach/derpin-china-new"

      # ç”Ÿæˆæ—¥æœŸæ ‡ç­¾ï¼ˆæ ¼å¼ï¼šå¹´æœˆæ—¥ï¼‰
      - name: Generate date-based tag
        run: |
          # ä½¿ç”¨UTCæ—¶é—´
          TAG_DATE="$(date -u +%Y%m%d)"
          echo "Date tag: $TAG_DATE"
          echo "TAG_DATE=$TAG_DATE" >> $GITHUB_ENV

      # ç™»å½•GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤5ï¼šå…‹éš†ç›®æ ‡ä»“åº“
      - name: Clone Derp-China-new repository
        run: |
          git clone ${{ env.TARGET_REPO }}
          cd Derp-China-new

      # æž„å»ºDockeré•œåƒ
      - name: Build Docker image
        run: |
          cd Derp-China-new
          docker build . \
            -t derpinchina:latest

      # ä¸ºé•œåƒæ‰“æ ‡ç­¾ï¼ˆæ—¥æœŸæ ‡ç­¾ + latestæ ‡ç­¾ï¼‰
      - name: Tag image for GHCR
        run: |
          # æ‰“æ—¥æœŸæ ‡ç­¾
          docker tag derpinchina:latest ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}
          # æ‰“latestæ ‡ç­¾
          docker tag derpinchina:latest ghcr.io/${{ env.IMAGE_NAME }}:latest
          # è¾“å‡ºæ‰€æœ‰æ ‡ç­¾
          docker images | grep ${{ env.IMAGE_NAME }}

      # æŽ¨é€é•œåƒåˆ°GHCR
      - name: Push image to GHCR
        run: |
          # æŽ¨é€æ—¥æœŸæ ‡ç­¾
          docker push ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}
          # æŽ¨é€latestæ ‡ç­¾
          docker push ghcr.io/${{ env.IMAGE_NAME }}:latest

      # ç™»å‡ºGHCR
      - name: Logout from GHCR
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œç™»å‡º
        run: docker logout ghcr.io

      # æž„å»ºç»“æžœæ‘˜è¦
      - name: Build summary
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¾“å‡ºæ‘˜è¦
        run: |
          echo "========================================"
          echo "ðŸ“¦ Docker Image Build Summary"
          echo "========================================"
          echo "âœ… Build completed with status: ${{ job.status }}"
          echo ""
          echo "ðŸ³ Container Information:"
          echo "- Registry: ghcr.io"
          echo "- Image Name: ${{ env.IMAGE_NAME }}"
          echo "- Tags: ${{ env.TAG_DATE }}, latest"
          echo "- Full Image Path: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}"
          echo ""
          echo "ðŸ”§ Build Details:"
          echo "- Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Trigger: ${{ github.event_name }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Runner: ${{ runner.os }} ${{ runner.name }}"
          echo ""
          echo "========================================"
          # è®¾ç½®ä½œä¸šæ‘˜è¦
          echo "## Dockeré•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          # æž„å»ºçŠ¶æ€ï¼ˆä½¿ç”¨å›¾æ ‡ï¼‰
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          # é•œåƒä¿¡æ¯
          echo "### ðŸ³ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“åœ°å€**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: ${{ env.TAG_DATE }}, latest" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Œæ•´é•œåƒè·¯å¾„**: ghcr.io/${{ env.IMAGE_NAME }}:${{ env.TAG_DATE }}" >> $GITHUB_STEP_SUMMARY
          # æž„å»ºè§¦å‘ä¿¡æ¯
          echo "### ðŸ”§ æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡ŒçŽ¯å¢ƒ**: ${{ runner.os }} ${{ runner.name }}" >> $GITHUB_STEP_SUMMARY