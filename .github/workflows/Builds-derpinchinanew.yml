name: è‡ªåŠ¨æž„å»º:Derpin-China-new

on:
  schedule:
    # æ¯å‘¨ä¸€ 00:00 åŒ—äº¬æ—¶é—´ æ‰§è¡Œ
    - cron: '0 0 * * 1'
      timezone: Asia/Shanghai
  workflow_dispatch:

# æƒé™é…ç½®ï¼šä»…æŽˆäºˆGHCRæŽ¨é€å¿…éœ€çš„æœ€å°æƒé™
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    env:
      # ç›®æ ‡ä»“åº“åœ°å€
      TARGET_REPO: https://github.com/lansepeach/Derp-China-new.git
      # é•œåƒåç§°
      IMAGE_NAME: lansepeach/derpin-china-new

    steps:
      # ç™»å½•GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          logout: false

      - name: Define Repo Owner Lower
        run: |
          # åˆå§‹åŒ–æ‰€æœ‰è€…å§“å
          # æŠŠgithub.repository_ownerè½¬ä¸ºçº¯å°å†™ï¼Œé¿å…å¤§å†™å¯¼è‡´çš„é•œåƒåç§°é”™è¯¯
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_OWNER_LOWER=${REPO_OWNER_LOWER}" >> $GITHUB_ENV

      - name: Get latest Tailscale Version
        run: |
          # èŽ·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆä»Ž GitHub API èŽ·å–æœ€æ–° release çš„ tag_nameï¼‰
          TAILSCALE_VERSION=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r '.tag_name' | sed 's/^v//')
          echo "Latest Tailscale Version: $TAILSCALE_VERSION"
          echo TAILSCALE_VERSION=$TAILSCALE_VERSION >> $GITHUB_ENV
      
      - name: Check if the Image Exists
        run: |
          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œç²¾ç®€ç‰ˆ
          IMAGE_URL="ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:v${{ env.TAILSCALE_VERSION }}"
          
          # ä½¿ç”¨ skopeo æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼ˆé™é»˜æ¨¡å¼ï¼Œä»…åˆ¤æ–­é€€å‡ºç ï¼‰
          if skopeo inspect --creds "user:${{ secrets.GITHUB_TOKEN }}" "docker://${IMAGE_URL}" >/dev/null 2>&1; then
            IMAGE_EXISTS="true"
          else
            IMAGE_EXISTS="false"
          fi
          
          echo "Image tag exists: $IMAGE_EXISTS"
          echo "IMAGE_EXISTS=$IMAGE_EXISTS" >> "$GITHUB_ENV"

      # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œè°ƒè¯•ç”¨
      #- name: Check if the image tag exists
      #  run: |
          # é•œåƒä»“åº“åœ°å€
      #    IMAGE_REPO="ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}"
      #    TAG_TO_CHECK="v${{ env.TAILSCALE_VERSION }}"
          
          # ä½¿ç”¨ skopeo åˆ—å‡ºé•œåƒä»“åº“çš„æ‰€æœ‰æ ‡ç­¾
          # --creds æ ¼å¼ï¼šç”¨æˆ·å:å¯†ç ï¼ˆGitHub å…è®¸ç”¨æˆ·åä»»æ„ï¼Œtoken ä½œä¸ºå¯†ç å³å¯ï¼‰
      #    skopeo list-tags "docker://${IMAGE_REPO}" \
      #      --creds "github-actions:${{ secrets.GITHUB_TOKEN }}" \
      #      > tags.json 2>&1
          
          # æ˜¾ç¤º skopeo å“åº”å†…å®¹ï¼ˆç”¨äºŽè°ƒè¯•ï¼Œå’ŒåŽŸè„šæœ¬ä¿æŒä¸€è‡´çš„è°ƒè¯•æ€§ï¼‰
      #    echo "Skopeo Response:"
      #    cat tags.json
          
          # æ£€æŸ¥ skopeo æ‰§è¡Œç»“æžœ & è§£æžæ ‡ç­¾åˆ—è¡¨
      #    if [ $? -ne 0 ] || grep -q "unauthorized" tags.json || grep -q "not found" tags.json; then
            # skopeo æ‰§è¡Œå¤±è´¥ï¼ˆä»“åº“ä¸å­˜åœ¨/è®¤è¯å¤±è´¥/ç½‘ç»œé—®é¢˜ï¼‰ï¼Œåˆ¤å®šé•œåƒä¸å­˜åœ¨
      #      echo "Skopeo æŸ¥è¯¢å¤±è´¥ï¼Œé•œåƒä»“åº“æˆ–æ ‡ç­¾ä¸å­˜åœ¨"
      #      IMAGE_EXISTS="false"
      #    else
            # ç”¨ jq è§£æž skopeo çš„ JSON è¾“å‡ºï¼Œæ£€æŸ¥ç›®æ ‡æ ‡ç­¾æ˜¯å¦åœ¨ Tags æ•°ç»„ä¸­
            # skopeo list-tags è¾“å‡ºæ ¼å¼ï¼š{"Name":"ghcr.io/xxx/xxx","Tags":["v1.0","v1.1"]}
      #      IMAGE_EXISTS=$(jq -e --arg tag "$TAG_TO_CHECK" \
      #        '.Tags[] | select(. == $tag)' tags.json > /dev/null 2>&1 && echo "true" || echo "false")
            
            # æ˜¾ç¤ºå¯ç”¨æ ‡ç­¾ï¼ˆè°ƒè¯•ç”¨ï¼‰
      #      echo "Available tags in repo ${IMAGE_REPO}:"
      #      jq -r '.Tags[]' tags.json 2>/dev/null || echo "æ— æ³•è§£æžæ ‡ç­¾åˆ—è¡¨"
      #    fi
          
      #    echo "Image tag ${TAG_TO_CHECK} exists: ${IMAGE_EXISTS}"
      #    echo "IMAGE_EXISTS=${IMAGE_EXISTS}" >> $GITHUB_ENV
      
      # å¦‚æžœé•œåƒå­˜åœ¨ï¼Œåœæ­¢CIè¿è¡Œ
      - name: Stop if image exists
        if: env.IMAGE_EXISTS == 'true'
        run: |
          echo "âŒ é•œåƒ ${{ env.IMAGE_NAME }}:v${{ env.TAILSCALE_VERSION }} å·²å­˜åœ¨ï¼Œç»ˆæ­¢æž„å»º"
          # ä½¿ç”¨éžé›¶é€€å‡ºç ç»ˆæ­¢CI
          exit 1

      - name: Generate Tag
        run: |
          # ç”Ÿæˆæ ‡ç­¾
          # é»˜è®¤æƒ…å†µï¼ˆå¦‚æ‰‹åŠ¨è§¦å‘ã€å®šæ—¶ä»»åŠ¡ç­‰ï¼‰ï¼Œä½¿ç”¨tailscaleç‰ˆæœ¬ï¼Œæ·»åŠ 'v'å‰ç¼€ä¸Žå®˜æ–¹ä¸€è‡´
          FINAL_TAG="v${{ env.TAILSCALE_VERSION }}"
          
          echo "Generated tag: $FINAL_TAG"
          echo "FINAL_TAG=$FINAL_TAG" >> $GITHUB_ENV

      - name: Clone Derp-China-new repository
        run: |
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone ${{ env.TARGET_REPO }}
          cd Derp-China-new

      - name: Build Docker Image
        run: |
          # æž„å»ºDockeré•œåƒ
          cd Derp-China-new
          docker build . \
            -t derpinchina:latest

      - name: Tag Image
        run: |
          # ä¸ºé•œåƒè®¾ç½®æ ‡ç­¾
          # ä½¿ç”¨tailscaleç‰ˆæœ¬ä½œä¸ºæ ‡ç­¾
          docker tag derpinchina:latest ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}
          # latest
          docker tag derpinchina:latest ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:latest
          # è¾“å‡ºé•œåƒä¿¡æ¯
          docker images | grep ${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}

      - name: Push Image
        run: |
          # æŽ¨é€é•œåƒ
          docker push ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}
          docker push ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:latest

      # ç™»å‡ºGHCR
      - name: Logout from GHCR
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œç™»å‡º
        run: docker logout ghcr.io

      - name: Verify Tailscale Version in Image
        id: verify_versions
        run: |
          # éªŒè¯Tailscaleç‰ˆæœ¬
          echo "=== Starting version verification ==="
          # 1. å¯åŠ¨ä¸´æ—¶å®¹å™¨
          CONTAINER_ID=$(docker run -d --rm --entrypoint sh derpinchina:latest -c "sleep 30")
          
          # 2. æå–é•œåƒå†…å®‰è£…çš„Tailscaleç‰ˆæœ¬
          TS_VERSION=$(docker exec $CONTAINER_ID tailscale --version 2>/dev/null | grep -Eo 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          # 3. åœæ­¢ä¸´æ—¶å®¹å™¨
          docker stop $CONTAINER_ID >/dev/null 2>&1
          
          # 4. ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°çŽ¯å¢ƒå˜é‡
          echo "TS_VERSION=$TS_VERSION" >> $GITHUB_ENV
          
          # 5. æ‰“å°ç‰ˆæœ¬ä¿¡æ¯
          echo "Installed Tailscale version: $TS_VERSION"
          echo "Expected Tailscale version: ${{ env.TAILSCALE_VERSION }}"
          
          # 6. æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´
          if [[ "$TS_VERSION" != "${{ env.TAILSCALE_VERSION }}" ]]; then
            echo "VERSION_MISMATCH=true" >> $GITHUB_ENV
            echo "WARNING: Version mismatch detected!" >&2
          else
            echo "VERSION_MISMATCH=false" >> $GITHUB_ENV
            echo "SUCCESS: Version verification completed!"
          fi

      - name: Build summary
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½è¾“å‡ºæ‘˜è¦
        run: |
          # è®¾ç½®ä½œä¸šæ‘˜è¦
          echo "## Dockeré•œåƒæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          
          # æž„å»ºçŠ¶æ€ï¼ˆä½¿ç”¨å›¾æ ‡ï¼‰
          if [ "${{ env.IMAGE_EXISTS }}" = "true" ]; then
            echo "âŒ **æž„å»ºçŠ¶æ€**: å·²ç»ˆæ­¢" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **ç»ˆæ­¢åŽŸå› **: é•œåƒå·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "- é•œåƒåœ°å€: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **æž„å»ºçŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºçŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ç‰ˆæœ¬ä¿¡æ¯
          echo "### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€æ–° Tailscale ç‰ˆæœ¬**: ${{ env.TAILSCALE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ Tailscale ç‰ˆæœ¬**: ${{ env.TS_VERSION || 'ä¸å¯ç”¨' }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.TS_VERSION }}" ]; then
            if [ "${{ env.VERSION_MISMATCH }}" = "true" ]; then
              echo "âš ï¸ **Tailscale ç‰ˆæœ¬ å­˜åœ¨å·®å¼‚ï¼Œè¯·æ£€æŸ¥**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Tailscale ç‰ˆæœ¬ å·²æœ€æ–°**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **ç‰ˆæœ¬ä¿¡æ¯èŽ·å–å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # é•œåƒä¿¡æ¯
          echo "### ðŸ³ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“åœ°å€**: ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒåç§°**: ${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: ${{ env.FINAL_TAG }}, latest" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Œæ•´é•œåƒè·¯å¾„**: ghcr.io/${{ env.REPO_OWNER_LOWER }}/${{ env.IMAGE_NAME }}:${{ env.FINAL_TAG }}" >> $GITHUB_STEP_SUMMARY

          # æž„å»ºè¯¦æƒ…
          echo "### ðŸ”§ æž„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY