#version: '3.8'

services:
  tailscale-derp:
    # 指定容器名称
    container_name: tailscale-derp
    image: derpinchina:latest
    build:
      # 指定 Dockerfile 所在的目录 (当前目录)
      context: .
    # 设置容器在宿主机重启后自动重启
    restart: unless-stopped
    # 挂载一个卷来持久化 tailscale 的状态，这样容器重启后无需重新认证
    volumes:
      - ./ts-state:/var/lib/tailscale
    # 端口映射: 将宿主机的端口映射到容器内暴露的端口
    ports:
      - "444:444"      # 将宿主机的 TCP 444 端口映射到容器的 TCP 444 端口
      - "3478:3478/udp" # 将宿主机的 UDP 3478 端口映射到容器的 UDP 3478 端口
    # --- 核心配置: 环境变量 ---
    # 在这里填入您自己的配置信息
    environment:
      # 您的 Tailscale 授权密钥 (建议使用一次性的 ephemeral key)
      - TAILSCALE_AUTH_KEY=tskey-auth-k...
      # 您为 DERP 服务器准备的公网域名
      - TAILSCALE_DERP_HOSTNAME=derp.yourdomain.com
      # （可选）DERP 监听地址，留空即可
      - TAILSCALE_DERP_ADDR=
      # STUN 端口，应与上面 ports 中暴露的 UDP 端口一致
      - TAILSCALE_DERP_STUN_PORT=3478
      # （推荐）开启客户端验证
      - TAILSCALE_DERP_VERIFY_CLIENTS=true
